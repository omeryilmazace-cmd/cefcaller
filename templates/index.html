<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEF Implied NAV Tracker</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: #00bcd4;
            margin-bottom: 10px;
        }

        .last-updated {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 30px;
        }

        /* Summary Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            margin-bottom: 40px;
        }

        .card {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .symbol {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .nav-change {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Holdings Tables Grid */
        .holdings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1800px;
        }

        .holdings-column {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }

        .column-header {
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
            text-align: center;
            color: #00bcd4;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        th {
            text-align: left;
            color: #888;
            padding: 5px;
        }

        td {
            padding: 4px 5px;
            border-bottom: 1px solid #2a2a2a;
        }

        .positive {
            color: #00e676;
        }

        .negative {
            color: #ff5252;
        }

        .neutral {
            color: #aaaaaa;
        }

        .log-box {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            width: 100%;
            max-width: 800px;
            height: 60px;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <h1>ðŸš€ CEF Implied NAV Monitor</h1>

    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 30px;">
        <div class="last-updated" id="timestamp" style="margin-bottom: 0;">Waiting for data...</div>
        <button onclick="sendTelegram()" style="
            background-color: #00bcd4; 
            border: none; 
            color: black; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;">
            ðŸ“¢ Send Update
        </button>
    </div>

    <div class="log-box" id="status-log">
        System Status: Initializing...
    </div>

    <!-- Top Summary Cards -->
    <div class="grid" id="dashboard-grid"></div>

    <!-- Detailed Holdings Columns -->
    <div class="holdings-container" id="holdings-grid"></div>

    <script>

        let globalData = null;
        let sortState = {}; // { "THQ": { col: "weight", dir: "desc" } }

        function toggleSort(cefName, col) {
            // Initialize or Toggle state
            if (!sortState[cefName]) {
                sortState[cefName] = { col: col, dir: 'desc' };
            } else {
                if (sortState[cefName].col === col) {
                    // Toggle direction
                    sortState[cefName].dir = sortState[cefName].dir === 'desc' ? 'asc' : 'desc';
                } else {
                    // New column, default to desc for metrics
                    sortState[cefName] = { col: col, dir: 'desc' };
                }
            }
            renderDashboard();
        }

        async function fetchData() {
            try {
                const response = await fetch('/data');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('status-log').innerText = "System Status: Fetching initial data from APIs... (This takes ~90s)";
                    return;
                }

                globalData = data;
                renderDashboard();

            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        function renderDashboard() {
            if (!globalData) return;

            const data = globalData;
            document.getElementById('timestamp').innerText = "Last Updated: " + data.last_updated;
            document.getElementById('status-log').innerText = `System Status: Data Refreshed at ${data.last_updated}`;

            // 1. Render Summary Cards
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            data.cefs.forEach(cef => {
                const card = document.createElement('div');
                card.className = 'card';

                const colorClass = cef.implied_move > 0 ? 'positive' : (cef.implied_move < 0 ? 'negative' : 'neutral');
                const sign = cef.implied_move > 0 ? '+' : '';

                card.innerHTML = `
                    <span class="symbol">${cef.name}</span>
                    <div class="nav-change ${colorClass}">${sign}${cef.implied_move.toFixed(3)}%</div>
                    <div style="color:#aaa; font-size:0.8em;">Weight: ${cef.tracked_weight}%</div>
                `;
                grid.appendChild(card);
            });

            // 2. Render Holdings Columns
            const holdingsGrid = document.getElementById('holdings-grid');
            holdingsGrid.innerHTML = '';

            data.cefs.forEach(cef => {
                const col = document.createElement('div');
                col.className = 'holdings-column';

                let tableRows = '';
                // Safe access to holdings
                let holdings = cef.holdings || [];

                // --- SORT LOGIC ---
                if (sortState[cef.name]) {
                    const s = sortState[cef.name];
                    holdings.sort((a, b) => {
                        let valA = a[s.col];
                        let valB = b[s.col];

                        // Handle nulls for change
                        if (s.col === 'change') {
                            if (valA === null) valA = -999999;
                            if (valB === null) valB = -999999;
                        }

                        // Handle string comparison for symbol
                        if (s.col === 'symbol') {
                            return s.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        }

                        if (valA < valB) return s.dir === 'asc' ? -1 : 1;
                        if (valA > valB) return s.dir === 'asc' ? 1 : -1;
                        return 0;
                    });
                } else {
                    // Default Sort: Weight Descending
                    holdings.sort((a, b) => b.weight - a.weight);
                }

                if (holdings.length === 0) {
                    tableRows = '<tr><td colspan="3" style="text-align:center;color:#666;">Loading...</td></tr>';
                } else {
                    holdings.forEach(h => {
                        let chgDisplay = '<span style="color:#666;">...</span>';
                        let chgClass = 'neutral';

                        if (h.change !== null) {
                            const chgColor = h.change > 0 ? 'positive' : (h.change < 0 ? 'negative' : 'neutral');
                            const sign = h.change > 0 ? '+' : '';
                            chgDisplay = `<span class="${chgColor}">${sign}${h.change.toFixed(2)}%</span>`;
                        }

                        tableRows += `
                            <tr>
                                <td>${h.symbol}</td>
                                <td style="text-align:right;">${h.weight}%</td>
                                <td style="text-align:right;">${chgDisplay}</td>
                            </tr>
                        `;
                    });
                }

                // Determine indicators
                const getSortInd = (key) => {
                    if (!sortState[cef.name]) return key === 'weight' ? 'â–¼' : ''; // Default
                    if (sortState[cef.name].col !== key) return '';
                    return sortState[cef.name].dir === 'asc' ? 'â–²' : 'â–¼';
                };

                col.innerHTML = `
                    <div class="column-header">${cef.name} Holdings</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="cursor:pointer" onclick="toggleSort('${cef.name}', 'symbol')">Sym ${getSortInd('symbol')}</th>
                                <th style="text-align:right; cursor:pointer" onclick="toggleSort('${cef.name}', 'weight')">Wgt ${getSortInd('weight')}</th>
                                <th style="text-align:right; cursor:pointer" onclick="toggleSort('${cef.name}', 'change')">%Chg ${getSortInd('change')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
                holdingsGrid.appendChild(col);
            });
        }

        async function sendTelegram() {
            const btn = document.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const response = await fetch('/send_telegram', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert("Message sent successfully!");
                } else {
                    alert("Error: " + result.message);
                }
            } catch (e) {
                alert("Request failed");
            }

            btn.innerText = originalText;
            btn.disabled = false;
        }

        setInterval(fetchData, 2000); // Poll every 2 seconds
        fetchData(); // Initial call
    </script>
</body>

</html>